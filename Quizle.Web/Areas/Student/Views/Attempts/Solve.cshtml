@model Quizle.Web.Areas.Student.Models.SolveQuestionVm
@using Quizle.Core.Types

@{
    ViewData["Title"] = "Solve Quiz";
}

<div class="container-md">
    <div class="card shadow-sm">
        <div class="card-body">

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger">@TempData["Error"]</div>
            }

            <div class="d-flex justify-content-between align-items-start gap-3 sticky-top bg-white pt-2" style="z-index:10;">
                <div>
                    <h5 class="mb-1">@Model.QuizTitle</h5>
                    <div class="text-muted small">
                        Question <strong>@(Model.Index + 1)</strong> / @Model.Total • @Model.Points pts
                    </div>
                </div>

                <div class="text-end">
                    <div class="small text-muted">Time left</div>
                    <div class="fs-5 fw-bold" id="timer">--:--</div>
                </div>
            </div>

            <hr />

            <div class="mb-3">
                <div class="fw-semibold mb-2">@Model.Text</div>

                @* Multiple choice *@
                @if (Model.Type == QuestionType.MultipleChoice)
                {
                    <div class="list-group">
                        @foreach (var opt in Model.Options)
                        {
                            var checkedAttr = (opt.Id == Model.SelectedOptionId) ? "checked" : "";
                            <label class="list-group-item d-flex gap-2 align-items-center">
                                <input class="form-check-input" type="radio" name="mc" value="@opt.Id" @checkedAttr />
                                <span>@opt.Text</span>
                            </label>
                        }
                    </div>
                }

                @* Numeric *@
                @if (Model.Type == QuestionType.Numeric)
                {
                    <input class="form-control form-control-lg"
                           type="number"
                           step="any"
                           id="numeric"
                           value="@(Model.NumericValue?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "")"
                           placeholder="Enter number..." />
                }

                @* Short text *@
                @if (Model.Type == QuestionType.ShortText)
                {
                    <textarea class="form-control"
                          rows="4"
                          id="text"
                          placeholder="Write your answer...">@Model.TextValue</textarea>
                }
            </div>

            <div class="d-flex justify-content-between gap-2">
                <button class="btn btn-outline-secondary"
                        id="btnPrev"
                        @(Model.Index == 0 ? "disabled" : "")>
                    Back
                </button>

                <div class="d-flex gap-2">
                    @if (Model.Index + 1 < Model.Total)
                    {
                        <button class="btn btn-primary" id="btnNext">Next</button>
                    }
                    else
                    {
                        <form asp-area="Student" asp-controller="Attempts" asp-action="Submit" method="post" class="m-0">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="attemptId" value="@Model.AttemptId" />
                            <button class="btn btn-success" id="btnSubmit" type="submit">Submit</button>
                        </form>
                    }
                </div>
            </div>

            <div class="mt-3">
                <div class="progress" style="height:8px;">
                    <div class="progress-bar"
                         role="progressbar"
                         style="width:@( (int)(((Model.Index + 1) * 100.0) / Model.Total) )%">
                    </div>
                </div>
            </div>

            @Html.AntiForgeryToken()
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
          const attemptId = "@Model.AttemptId";
          const questionId = "@Model.QuestionId";
          const index = @Model.Index;
          const total = @Model.Total;

          const activeUntilUtc = new Date("@Model.ActiveUntilUtc.ToString("O")");
          const timerEl = document.getElementById("timer");

          function pad(n){ return n.toString().padStart(2,'0'); }

          function tick(){
            const ms = activeUntilUtc.getTime() - Date.now();
            if(ms <= 0){
              timerEl.textContent = "00:00";
              // Optionally auto-submit or disable inputs
              return;
            }
            const s = Math.floor(ms/1000);
            const m = Math.floor(s/60);
            const r = s%60;
            timerEl.textContent = `${pad(m)}:${pad(r)}`;
            requestAnimationFrame(()=>{});
          }
          setInterval(tick, 500);
          tick();

          function getAntiForgery(){
            // last token rendered in page
            const input = document.querySelector('input[name="__RequestVerificationToken"]');
            return input ? input.value : "";
          }

          function readAnswer(){
            let selectedOptionId = null;
            let numericValue = null;
            let textValue = null;

            const checked = document.querySelector('input[name="mc"]:checked');
            if(checked) selectedOptionId = checked.value;

            const numeric = document.getElementById("numeric");
            if(numeric && numeric.value !== "") numericValue = parseFloat(numeric.value);

            const text = document.getElementById("text");
            if(text) textValue = text.value;

            return { attemptId, questionId, selectedOptionId, numericValue, textValue };
          }

          async function save(){
            const payload = readAnswer();
            const res = await fetch("@Url.Action("SaveAnswer", "Attempts", new { area = "Student" })", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "RequestVerificationToken": getAntiForgery()
              },
              body: JSON.stringify(payload)
            });

            if(!res.ok){
              const data = await res.json().catch(()=>null);
              alert(data?.message || "Failed to save answer.");
              return false;
            }
            return true;
          }

          async function goTo(newIndex){
            const ok = await save();
            if(!ok) return;
            const url = "@Url.Action("Solve", "Attempts", new { area = "Student" })" + `?attemptId=${encodeURIComponent(attemptId)}&index=${newIndex}`;
            window.location.href = url;
          }

          const btnPrev = document.getElementById("btnPrev");
          if(btnPrev){
            btnPrev.addEventListener("click", e => {
              e.preventDefault();
              if(index > 0) goTo(index - 1);
            });
          }

          const btnNext = document.getElementById("btnNext");
          if(btnNext){
            btnNext.addEventListener("click", e => {
              e.preventDefault();
              if(index + 1 < total) goTo(index + 1);
            });
          }

          // Optional: autosave on change (lightweight)
          document.addEventListener("change", (e) => {
            if(e.target && (e.target.name === "mc" || e.target.id === "numeric")) save();
          });

        })();
    </script>
}
