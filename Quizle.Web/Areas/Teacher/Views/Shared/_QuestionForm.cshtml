@model QuestionEditVm
@using Quizle.Core.Types

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

<h3 class="mb-3">@ViewData["Title"]</h3>

<form method="post">
    @Html.AntiForgeryToken()
    @if (!string.IsNullOrWhiteSpace(Model.Id))
    {
        <input type="hidden" asp-for="Id" />
    }

    <div class="mb-3">
        <label class="form-label">Type</label>
        <select class="form-select" asp-for="Type" id="qType">
            <option value="@QuestionType.MultipleChoice">MultipleChoice</option>
            <option value="@QuestionType.Numeric">Numeric</option>
            <option value="@QuestionType.ShortText">ShortText</option>
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">Text</label>
        <textarea class="form-control" asp-for="Text" rows="3"></textarea>
        <span class="text-danger" asp-validation-for="Text"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Points</label>
        <input class="form-control" type="number" asp-for="Points" min="1" max="100" />
        <span class="text-danger" asp-validation-for="Points"></span>
    </div>

    <!-- MultipleChoice -->
    <div id="mcBox" class="card mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Options</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddOpt">Add option</button>
            </div>

            <div id="opts">
                @for (int i = 0; i < Model.Options.Count; i++)
                {
                    <div class="row g-2 align-items-center mb-2 opt-row" data-index="@i">
                        <input type="hidden" name="Options[@i].Id" value="@Model.Options[i].Id" />
                        <div class="col-1 text-center">
                            <input class="form-check-input" type="radio"
                                   name="CorrectIndex" value="@i"
                                   @(Model.CorrectIndex == i ? "checked" : "") />
                        </div>
                        <div class="col-9">
                            <input class="form-control" name="Options[@i].Text" value="@Model.Options[i].Text" placeholder="Option text..." />
                        </div>
                        <div class="col-2 text-end">
                            <button type="button" class="btn btn-outline-danger btn-sm btnRemove">Remove</button>
                        </div>
                    </div>
                }
            </div>

            <div class="small text-muted">Pick the correct option using the radio button.</div>
        </div>
    </div>

    <!-- Numeric -->
    <div id="numBox" class="card mb-3">
        <div class="card-body">
            <h5>Numeric</h5>
            <div class="row g-2">
                <div class="col-12 col-md-6">
                    <label class="form-label">Correct number</label>
                    <input class="form-control" type="number" step="any" asp-for="CorrectNumeric" />
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label">Tolerance</label>
                    <input class="form-control" type="number" step="any" asp-for="NumericTolerance" placeholder="e.g. 0.01" />
                </div>
            </div>
        </div>
    </div>

    <!-- ShortText -->
    <div id="txtBox" class="alert alert-info">
        ShortText questions are not auto-graded (for now). You can review them later in Results.
    </div>

    <div class="d-flex gap-2">
        <button class="btn btn-primary" type="submit">Save</button>
        <a class="btn btn-secondary" asp-area="Teacher" asp-controller="Questions" asp-action="Index">Back</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function(){
          const typeSel = document.getElementById('qType');
          const mcBox = document.getElementById('mcBox');
          const numBox = document.getElementById('numBox');
          const txtBox = document.getElementById('txtBox');
          const opts = document.getElementById('opts');
          const addBtn = document.getElementById('btnAddOpt');

          function showByType(){
            const t = typeSel.value;
            mcBox.style.display = (t == 'MultipleChoice') ? '' : 'none';
            numBox.style.display = (t == 'Numeric') ? '' : 'none';
            txtBox.style.display = (t == 'ShortText') ? '' : 'none';
          }

          function renumber(){
            const rows = opts.querySelectorAll('.opt-row');
            rows.forEach((row, i) => {
              row.setAttribute('data-index', i);

              // hidden id
              row.querySelector('input[type="hidden"]').setAttribute('name', `Options[${i}].Id`);

              // text
              row.querySelector('input.form-control').setAttribute('name', `Options[${i}].Text`);

              // radio
              row.querySelector('input[type="radio"]').setAttribute('value', i);
            });
          }

          addBtn?.addEventListener('click', () => {
            const i = opts.querySelectorAll('.opt-row').length;

            const div = document.createElement('div');
            div.className = 'row g-2 align-items-center mb-2 opt-row';
            div.setAttribute('data-index', i);

            div.innerHTML = `
              <input type="hidden" name="Options[${i}].Id" value="" />
              <div class="col-1 text-center">
                <input class="form-check-input" type="radio" name="CorrectIndex" value="${i}" />
              </div>
              <div class="col-9">
                <input class="form-control" name="Options[${i}].Text" value="" placeholder="Option text..." />
              </div>
              <div class="col-2 text-end">
                <button type="button" class="btn btn-outline-danger btn-sm btnRemove">Remove</button>
              </div>
            `;
            opts.appendChild(div);
          });

          opts?.addEventListener('click', (e) => {
            const btn = e.target.closest('.btnRemove');
            if(!btn) return;

            const row = btn.closest('.opt-row');
            row.remove();
            renumber();

            // ensure at least one correct selected if possible
            const radios = opts.querySelectorAll('input[type="radio"]');
            if(radios.length && !opts.querySelector('input[type="radio"]:checked')){
              radios[0].checked = true;
            }
          });

          typeSel?.addEventListener('change', showByType);
          showByType();
          renumber();
        })();
    </script>
}
